<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>בדיקת עליות לתורה</title>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
   <style>
       @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');

       :root {
           --primary-color: #1a365d;
           --secondary-color: #2b6cb0;
           --accent-color: #4299e1;
           --background-color: #f7fafc;
           --card-background: #ffffff;
           --text-color: #2d3748;
           --success-color: #48bb78;
           --border-color: #e2e8f0;
           --shadow-color: rgba(0, 0, 0, 0.1);
           --mobile-breakpoint: 600px;
       }

       * {
           box-sizing: border-box;
           margin: 0;
           padding: 0;
           font-family: 'Heebo', sans-serif;
       }

       body {
           background-color: var(--background-color);
           color: var(--text-color);
           line-height: 1.6;
           padding: 20px;
       }

       .container {
           max-width: 1200px;
           margin: 0 auto;
           background-color: var(--card-background);
           border-radius: 15px;
           box-shadow: 0 10px 20px var(--shadow-color);
           padding: 2rem;
       }

       h1, h2 {
           color: var(--primary-color);
           text-align: center;
           margin-bottom: 1.5rem;
       }

       h1 {
           font-size: 2rem;
           margin-bottom: 2rem;
       }

       h2 {
           font-size: 1.5rem;
           border-bottom: 2px solid var(--accent-color);
           padding-bottom: 0.5rem;
           margin: 2rem 0;
       }

       /* טאבים */
       .tabs {
           display: flex;
           gap: 1rem;
           margin-bottom: 2rem;
           border-bottom: 2px solid var(--border-color);
           padding: 0 1rem;
       }

       .tab {
           padding: 1rem 2rem;
           font-size: 1.2rem;
           color: var(--text-color);
           background: none;
           border: none;
           cursor: pointer;
           position: relative;
           transition: all 0.3s ease;
       }

       .tab.active {
           color: var(--primary-color);
           font-weight: 600;
       }

       .tab.active::after {
           content: '';
           position: absolute;
           bottom: -2px;
           left: 0;
           right: 0;
           height: 2px;
           background-color: var(--primary-color);
       }

       .panel {
           display: none;
           padding: 1rem;
       }

       .panel.active {
           display: block;
       }

       /* טופס תאריך */
       .date-section {
           display: flex;
           flex-direction: column;
           align-items: center;
           gap: 1rem;
           margin-bottom: 2rem;
       }

       input[type="date"],
       select,
       input[type="text"] {
           padding: 0.8rem;
           border: 2px solid var(--border-color);
           border-radius: 8px;
           font-size: 1rem;
           width: 100%;
           max-width: 300px;
           transition: border-color 0.3s ease;
       }

       input[type="date"]:focus,
       select:focus,
       input[type="text"]:focus {
           border-color: var(--accent-color);
           outline: none;
       }

       .btn {
           background-color: var(--secondary-color);
           color: white;
           border: none;
           padding: 0.8rem 1.5rem;
           border-radius: 8px;
           font-size: 1rem;
           cursor: pointer;
           transition: background-color 0.3s ease;
           min-width: 120px;
       }

       .btn:hover {
           background-color: var(--primary-color);
       }

       /* טבלת תוצאות */
       .result-table {
           width: 100%;
           border-collapse: separate;
           border-spacing: 0;
           margin: 2rem 0;
           border-radius: 8px;
           overflow: hidden;
           box-shadow: 0 4px 6px var(--shadow-color);
       }

       .result-table th,
       .result-table td {
           padding: 1rem;
           text-align: right;
           border-bottom: 1px solid var(--border-color);
       }

       .result-table th {
           background-color: var(--primary-color);
           color: white;
           font-weight: 500;
       }

       .result-table tr:last-child td {
           border-bottom: none;
       }

       /* שורות עלייה */
       .aliyah-container {
           background-color: white;
           border-radius: 8px;
           padding: 1.5rem;
           margin-bottom: 1.5rem;
           box-shadow: 0 2px 4px var(--shadow-color);
       }

       .aliyah-row {
           display: grid;
           grid-template-columns: minmax(120px, auto) 1fr auto;
           gap: 1rem;
           align-items: center;
           padding: 1rem;
           background-color: var(--background-color);
           border-radius: 8px;
           margin-bottom: 1rem;
       }

       .aliyah-row label {
           font-weight: 500;
           color: var(--primary-color);
       }

       /* הודעות הצלחה */
       .success-message {
           background-color: var(--success-color);
           color: white;
           padding: 1rem;
           border-radius: 8px;
           margin-top: 1rem;
           text-align: center;
           animation: fadeIn 0.3s ease;
       }

       @keyframes fadeIn {
           from { opacity: 0; transform: translateY(-10px); }
           to { opacity: 1; transform: translateY(0); }
       }

       /* מתפללים */
       .congregants-list {
           display: grid;
           grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
           gap: 1rem;
           margin-top: 2rem;
       }

       .congregant-card {
           background-color: white;
           padding: 1rem;
           border-radius: 8px;
           box-shadow: 0 2px 4px var(--shadow-color);
           display: flex;
           justify-content: space-between;
           align-items: center;
       }

       .congregant-info {
           display: flex;
           flex-direction: column;
           gap: 0.5rem;
       }

       .congregant-name {
           font-weight: 600;
           color: var(--primary-color);
       }

       .congregant-type {
           color: var(--secondary-color);
           font-size: 0.9rem;
       }
       .aliyah-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background-color: var(--background-color);
    border-radius: 8px;
    margin-bottom: 1rem;
}

.assignee-display {
    flex: 1;
    padding: 0.5rem;
    background-color: white;
    border-radius: 4px;
    border: 1px solid var(--border-color);
}

.buttons-container {
    display: flex;
    gap: 0.5rem;
}

.congregant-select {
    padding: 0.5rem;
    border-radius: 4px;
    border: 1px solid var(--border-color);
}

.btn-primary {
    background-color: var(--primary-color);
}

.btn-danger {
    background-color: #dc3545;
}

       /* רספונסיביות */
       @media (max-width: 768px) {
           .container {
               padding: 1rem;
           }

           .tabs {
               flex-direction: column;
           }

           .aliyah-row {
               grid-template-columns: 1fr;
           }

           .btn {
               width: 100%;
           }

           .result-table {
               display: block;
               overflow-x: auto;
               white-space: nowrap;
           }
       }
   </style>
</head>
<body>
   <div class="container">
       <h1>ניהול בית הכנסת</h1>

       <div class="tabs">
           <button class="tab active" onclick="showPanel('aliyot')">עליות לתורה</button>
           <button class="tab" onclick="showPanel('congregants')">ניהול מתפללים</button>
       </div>

       <!-- פאנל עליות -->
       <div id="aliyotPanel" class="panel active">
           <div class="date-section">
               <input type="date" id="dateInput">
               <button onclick="checkAliyot()" class="btn">בדוק עליות</button>
           </div>

           <div id="selected-date-display"></div>

           <table class="result-table" style="display:none;" id="resultTable">
               <thead>
                   <tr>
                       <th>תאריך לועזי</th>
                       <th>תאריך עברי</th>
                       <th>יום בשבוע</th>
                       <th>פרשת השבוע</th>
                       <th>מספר עולים</th>
                       <th>סוג עולים</th>
                       <th>סיבה</th>
                   </tr>
               </thead>
               <tbody id="resultBody"></tbody>
           </table>

           <div id="aliyotContainer" style="display:none;">
               <h2>בחירת עולים</h2>
               <div id="templeActions">
                   <h3>פעולות בהיכל</h3>
                   <div id="templeActionsList"></div>
               </div>
               <div id="aliyotList">
                   <h3>עליות לתורה</h3>
                   <div id="aliyotInputs"></div>
               </div>
               <button class="btn" onclick="addCustomAliyah(orderManager)">הוסף עלייה נוספת</button>
           </div>
       </div>

       <!-- פאנל מתפללים -->
       <div id="congregantsPanel" class="panel">
           <div class="congregant-form">
               <h2>הוספת מתפלל חדש</h2>
               <form id="congregantForm" onsubmit="submitCongregant(event)">
                   <div class="form-group">
                       <label for="congregantName">שם המתפלל:</label>
                       <input type="text" id="congregantName" required>
                   </div>
                   <div class="form-group">
                       <label for="congregantType">סיווג:</label>
                       <select id="congregantType" required>
                           <option value="">בחר סיווג</option>
                           <option value="כהן">כהן</option>
                           <option value="לוי">לוי</option>
                           <option value="ישראל">ישראל</option>
                       </select>
                   </div>
                   <button type="submit" class="btn">הוסף מתפלל</button>
               </form>
           </div>

           <button class="btn" onclick="refreshCongregantsList()">רענן רשימת מתפללים</button>
           <div id="congregantsList" class="congregants-list"></div>
       </div>
   </div>

   <script>
   // קבועים
       const MITPALLELIM_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQouqJcCsVqZIJXqRXQ2eokBBLWR9iJgSH80Ny39pgLleeEhl23CfnIlrHZeipNG_UprBZBPtsWcxq9/pub?output=csv';
       const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLScn_XYgi5J4QdDFj0SFa2Blm_utiqYSN3bdghuwa5wJT9TNTA/formResponse';
       const CONGREGANT_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfQ7ZVEbBVCJMXUIJ3x1YYkL1Isc0FvF810QAT2mNyMticLQA/formResponse';
       const ORDER_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRje6xFwhIsqeM0Pfx-G_N7fdLWv6vMEdWUXChKLLmNjmavQkWq6pAADNT3hA1KcyxJjPOsGeFgSCgR/pub?output=csv';
      const ORDER_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLScKftuA7gnj8EDBJqYv7fPR17Zi8Xp0W17JYl9EJrT0BmnmLQ/formResponse';

       const FORM_ENTRIES = {
           date: 'entry.692073583',
           parasha: 'entry.566476837',
           aliyaType: 'entry.1648488199',
           olehName: 'entry.623077070'
       };

       const CONGREGANT_FORM_ENTRIES = {
           name: 'entry.534710632',
           type: 'entry.1356020608'
       };

       const ORDER_FORM_ENTRIES = {
           name: 'entry.75563866',
           position: 'entry.891400757'
       };

       const PARASHA_TRANSLATIONS = {
           'Bereshit': 'בראשית', 'Noach': 'נח', 'Lech Lecha': 'לך לך',
           'Vayera': 'וירא', 'Chayei Sarah': 'חיי שרה', 'Toldot': 'תולדות',
           'Vayetzei': 'ויצא', 'Vayishlach': 'וישלח', 'Vayeshev': 'וישב',
           'Miketz': 'מקץ', 'Vayigash': 'ויגש', 'Vayechi': 'ויחי',
           'Shemot': 'שמות', 'Vaera': 'וארא', 'Bo': 'בא',
           'Beshalach': 'בשלח', 'Yitro': 'יתרו', 'Mishpatim': 'משפטים',
           'Terumah': 'תרומה', 'Tetzaveh': 'תצווה', 'Ki Tisa': 'כי תשא',
           'Vayakhel': 'ויקהל', 'Pekudei': 'פקודי', 'Vayikra': 'ויקרא',
           'Tzav': 'צו', 'Shemini': 'שמיני', 'Tazria': 'תזריע',
           'Metzora': 'מצורע', 'Acharei Mot': 'אחרי מות', 'Kedoshim': 'קדושים',
           'Emor': 'אמור', 'Behar': 'בהר', 'Bechukotai': 'בחוקותי',
           'Bamidbar': 'במדבר', 'Nasso': 'נשא', 'Beha\'alotcha': 'בהעלותך',
           'Shelach': 'שלח לך', 'Korach': 'קורח', 'Chukat': 'חוקת',
           'Balak': 'בלק', 'Pinchas': 'פינחס', 'Matot': 'מטות',
           'Masei': 'מסעי', 'Devarim': 'דברים', 'Vaetchanan': 'ואתחנן',
           'Eikev': 'עקב', 'Re\'eh': 'ראה', 'Shoftim': 'שופטים',
           'Ki Tetzei': 'כי תצא', 'Ki Tavo': 'כי תבוא', 'Nitzavim': 'נצבים',
           'Vayeilech': 'וילך', 'Ha\'azinu': 'האזינו', 'Vezot Habracha': 'וזאת הברכה'
       };

       const hebrewDays = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
       const TEMPLE_ACTIONS = ['פתיחת ההיכל', 'הולכת ספר תורה', 'הגבהת ספר תורה'];

       // משתנים גלובליים
       let mitpallelimList = [];
       let currentParasha = '';
       let dateInput = null;
       let orderManager = null;

       // מחלקת ניהול סדר העליות
       class AliyotOrderManager {
     constructor() {
         this.orderList = new Map();        // מיפוי מיקום -> שם
         this.temporaryOrder = new Map();    // מיפוי זמני
         this.assignedToday = new Set();     // שמות המשובצים היום
         this.lockedAssignments = new Set(); // עליות נעולות
         this.mitpallelimList = [];          // רשימת המתפללים המלאה
     }

     // טעינת רשימת המתפללים
     async loadMitpallelim() {
         try {
             console.log('טוען רשימת מתפללים מ:', MITPALLELIM_CSV);
             const response = await fetch(MITPALLELIM_CSV);
             if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

             const text = await response.text();
             const result = Papa.parse(text, {
                 header: true,
                 skipEmptyLines: true
             });

             this.mitpallelimList = result.data.map(row => ({
                 name: row['Name'] || row['שם'] || row[Object.keys(row)[0]], // גמיש לשמות עמודות שונים
                 type: row['Type'] || row['סוג'] || row[Object.keys(row)[1]]  // גמיש לשמות עמודות שונים
             })).filter(m => m.name && m.type); // סינון רשומות לא תקינות

             console.log('נטענו', this.mitpallelimList.length, 'מתפללים');
             return this.mitpallelimList;
         } catch (error) {
             console.error('שגיאה בטעינת רשימת מתפללים:', error);
             throw error;
         }
     }
     // נעדכן את פונקציית initialize:
     async initialize() {
         try {
             console.log('מתחיל אתחול מנהל העליות');
             
             // קודם כל טוען את רשימת המתפללים
             this.mitpallelimList = await this.loadMitpallelim();
             console.log('נטענו', this.mitpallelimList.length, 'מתפללים:', this.mitpallelimList);
             
             // טעינת הסדר הקיים
             console.log('טוען סדר עליות מ:', ORDER_CSV);
             const response = await fetch(ORDER_CSV);
             if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
             
             const text = await response.text();
             const result = Papa.parse(text, {
                 header: true,
                 skipEmptyLines: true
             });
     
             // איפוס המפות הקיימות
             this.orderList.clear();
             this.temporaryOrder.clear();
     
             // מילוי הסדר מהנתונים שהתקבלו
             result.data.forEach((row, index) => {
                 const name = row['Name'] || row['שם'] || row[Object.keys(row)[0]];
                 const position = parseInt(row['Position'] || row['מיקום'] || row[Object.keys(row)[1]]) || index + 1;
                 
                 if (name) {
                     this.orderList.set(position, name);
                 }
             });
     
             // אם אין סדר קיים, יוצר סדר התחלתי
             if (this.orderList.size === 0) {
                 this.mitpallelimList.forEach((mitpallel, index) => {
                     this.orderList.set(index + 1, mitpallel.name);
                 });
             }
     
             // העתקת הסדר הנוכחי לרשימה הזמנית
             this.temporaryOrder = new Map(this.orderList);
             
             return true;
         } catch (error) {
             console.error('שגיאה באתחול:', error);
             throw error;
         }
     }
     
     // נעדכן את פונקציית createAliyahAssignmentRow:
    
     
     // בדיקת התאמה לסוג העלייה
     isEligibleForAliya(mitpallel, type) {
         if (!mitpallel || this.assignedToday.has(mitpallel.name)) {
             return false;
         }

         if (TEMPLE_ACTIONS.includes(type)) {
             return true;
         }

         switch(type) {
             case 'כהן': return mitpallel.type === 'כהן';
             case 'לוי': return mitpallel.type === 'לוי';
             default: return mitpallel.type === 'ישראל';
         }
     }

     // קבלת המתפלל הבא בתור
     getNextEligibleForAliya(type, alreadyAssigned = []) {
         const positions = Array.from(this.temporaryOrder.keys()).sort((a, b) => a - b);

         for (const pos of positions) {
             const name = this.temporaryOrder.get(pos);
             const mitpallel = this.mitpallelimList.find(m => m.name === name);

             if (!mitpallel) continue;
             if (this.assignedToday.has(name)) continue;
             if (alreadyAssigned.includes(name)) continue;

             if (this.isEligibleForAliya(mitpallel, type)) {
                 return { mitpallel, position: pos };
             }
         }

         return null;
     }

     // שיבוץ אוטומטי של כל העליות
     async autoAssignAliyot(aliyotTypes) {
         try {
             const assignments = new Map();
             const assignedPeople = [];

             // פעולות בהיכל
             for (const action of TEMPLE_ACTIONS) {
                 const next = this.getNextEligibleForAliya(action, assignedPeople);
                 if (next) {
                     assignments.set(action, next.mitpallel);
                     assignedPeople.push(next.mitpallel.name);
                 }
             }

             // עליות לתורה
             for (const aliyaType of aliyotTypes) {
                 const next = this.getNextEligibleForAliya(aliyaType, assignedPeople);
                 if (next) {
                     assignments.set(aliyaType, next.mitpallel);
                     assignedPeople.push(next.mitpallel.name);
                 }
             }

             return assignments;
         } catch (error) {
             console.error('שגיאה בשיבוץ אוטומטי:', error);
             return new Map();
         }
     }

     // שיבוץ עלייה והזזה לסוף
     async assignAliyah(name, type) {
         try {
             if (this.lockedAssignments.has(type)) {
                 throw new Error('העלייה כבר ננעלה');
             }

             const newPosition = this.getLastPosition() + 1;
             await this.submitToGoogleSheets(name, newPosition);

             this.temporaryOrder.set(newPosition, name);
             this.lockedAssignments.add(type);
             this.assignedToday.add(name);

             return true;
         } catch (error) {
             console.error('שגיאה בשיבוץ:', error);
             return false;
         }
     }

     // טיפול בהיעדרות
     async handleAbsence(name) {
         const currentPos = this.findPersonPosition(name);
         if (currentPos === null) return false;

         try {
             const positions = Array.from(this.temporaryOrder.keys()).sort((a, b) => a - b);
             const currentIndex = positions.indexOf(currentPos);
             const newIndex = Math.min(currentIndex + 5, positions.length - 1);
             const newPosition = positions[newIndex];

             await this.submitToGoogleSheets(name, newPosition);
             this.movePersonInTemporaryOrder(name, newPosition);

             return true;
         } catch (error) {
             console.error('שגיאה בטיפול בהיעדרות:', error);
             return false;
         }
     }

     // בחירה חופשית
     async handleFreeChoice(originalName, newName, type) {
         if (this.lockedAssignments.has(type)) {
             throw new Error('העלייה כבר ננעלה');
         }

         try {
             const newPosition = this.getLastPosition() + 1;
             await this.submitToGoogleSheets(newName, newPosition);

             this.temporaryOrder.set(newPosition, newName);
             this.assignedToday.add(newName);
             this.lockedAssignments.add(type);

             return true;
         } catch (error) {
             console.error('שגיאה בבחירה חופשית:', error);
             return false;
         }
     }

     // פונקציות עזר
     getLastPosition() {
         const positions = Array.from(this.temporaryOrder.keys());
         return positions.length > 0 ? Math.max(...positions) : 0;
     }

     findPersonPosition(name) {
         for (const [pos, personName] of this.temporaryOrder.entries()) {
             if (personName === name) return pos;
         }
         return null;
     }

     movePersonInTemporaryOrder(name, newPosition) {
         const oldPosition = this.findPersonPosition(name);
         if (oldPosition !== null) {
             this.temporaryOrder.delete(oldPosition);
         }
         this.temporaryOrder.set(newPosition, name);
     }

     // שליחה לגוגל שיטס
     async submitToGoogleSheets(name, position) {
         const formData = new FormData();
         formData.append(ORDER_FORM_ENTRIES.name, name);
         formData.append(ORDER_FORM_ENTRIES.position, position.toString());

         await fetch(ORDER_FORM_URL, {
             method: 'POST',
             mode: 'no-cors',
             body: formData
         });
     }
 }
       // פונקציות עזר
       function showPanel(panelId) {
           document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
           document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

           document.getElementById(`${panelId}Panel`).classList.add('active');
           document.querySelector(`[onclick="showPanel('${panelId}')"]`).classList.add('active');
       }

       async function getParasha(date) {
           try {
               const response = await fetch(`https://www.hebcal.com/converter?cfg=json&date=${date}&g2h=1&strict=1`);
               const data = await response.json();
               const parashaEvent = data.events?.find(event => event.includes('Parashat'));
               return parashaEvent ?
                   PARASHA_TRANSLATIONS[parashaEvent.replace('Parashat ', '')] ||
                   parashaEvent.replace('Parashat ', '') :
                   'לא זוהתה פרשה';
           } catch (error) {
               console.error('שגיאה בקבלת פרשת השבוע:', error);
               return 'לא זוהתה פרשה';
           }
       }

       async function getHebcalInfo(date) {
           try {
               const response = await fetch(`https://www.hebcal.com/converter?cfg=json&date=${date}&g2h=1&strict=1`);
               const data = await response.json();
               return {
                   hebrewDate: data.hebrew,
                   holidays: data.events || [],
                   dayOfWeek: new Date(date).getDay()
               };
           } catch (error) {
               console.error('שגיאה בקבלת מידע מ-Hebcal:', error);
               return null;
           }
       }

       function determineAliyotCount(hebcalInfo) {
           if (!hebcalInfo) return { totalAliyot: 0, aliyotTypes: [], reason: 'לא זוהה' };

           if (hebcalInfo.dayOfWeek === 6) {
               return {
                   totalAliyot: 7,
                   aliyotTypes: ['כהן', 'לוי', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'מפטיר'],
                   reason: 'שבת'
               };
           }

           if (hebcalInfo.dayOfWeek === 1 || hebcalInfo.dayOfWeek === 4) {
               return {
                   totalAliyot: 3,
                   aliyotTypes: ['כהן', 'לוי', 'שלישי'],
                   reason: 'יום שני או חמישי'
               };
           }

           if (hebcalInfo.holidays.some(h => h.includes('Rosh Chodesh'))) {
               return {
                   totalAliyot: 4,
                   aliyotTypes: ['כהן', 'לוי', 'ישראל', 'ישראל'],
                   reason: 'ראש חודש'
               };
           }

           if (hebcalInfo.holidays.some(h => h.includes('Fast'))) {
               return {
                   totalAliyot: 3,
                   aliyotTypes: ['כהן', 'לוי', 'ישראל'],
                   reason: 'יום צום'
               };
           }

           if (hebcalInfo.holidays.some(h => h.includes('Chanukah'))) {
               return {
                   totalAliyot: 3,
                   aliyotTypes: ['כהן', 'לוי', 'ישראל'],
                   reason: 'חנוכה'
               };
           }

           if (hebcalInfo.holidays.some(h => h.includes('Chol Hamoed'))) {
               return {
                   totalAliyot: 4,
                   aliyotTypes: ['כהן', 'לוי', 'ישראל', 'ישראל'],
                   reason: 'חול המועד'
               };
           }

           return { totalAliyot: 0, aliyotTypes: [], reason: 'יום חול רגיל' };
       }

       // פונקציה שקוראת כשבוחרים עולה

 async function submitAliyaToForm(date, parasha, aliyaType, olehName, targetElement) {
     try {
         const formData = new FormData();
         formData.append(FORM_ENTRIES.date, date);
         formData.append(FORM_ENTRIES.parasha, parasha);
         formData.append(FORM_ENTRIES.aliyaType, aliyaType);
         formData.append(FORM_ENTRIES.olehName, olehName);

         await fetch(GOOGLE_FORM_URL, {
             method: 'POST',
             mode: 'no-cors',
             body: formData
         });

         const successMsg = document.createElement('div');
         successMsg.className = 'success-message';
         successMsg.textContent = `עלייה עבור ${olehName} (${aliyaType}) נשלחה בהצלחה!`;

         const parentRow = targetElement.closest('.aliyah-row');
         if (parentRow) {
             parentRow.appendChild(successMsg);
             setTimeout(() => successMsg.remove(), 3000);
         }

     } catch (error) {
         console.error('שגיאה בשליחת הטופס:', error);
     }
 }
       async function submitCongregant(event) {
           event.preventDefault();

           const name = document.getElementById('congregantName').value;
           const type = document.getElementById('congregantType').value;

           if (!name || !type) {
               alert('אנא מלא את כל השדות');
               return;
           }

           const formData = new FormData();
           formData.append(CONGREGANT_FORM_ENTRIES.name, name);
           formData.append(CONGREGANT_FORM_ENTRIES.type, type);

           try {
               await fetch(CONGREGANT_FORM_URL, {
                   method: 'POST',
                   mode: 'no-cors',
                   body: formData
               });

               const successMsg = document.createElement('div');
               successMsg.className = 'success-message';
               successMsg.textContent = 'המתפלל נוסף בהצלחה!';
               event.target.appendChild(successMsg);
               event.target.reset();

               setTimeout(() => {
                   successMsg.remove();
                   refreshCongregantsList();
               }, 60000);

           } catch (error) {
               console.error('שגיאה בהוספת מתפלל:', error);
               alert('אירעה שגיאה בהוספת המתפלל');
           }
       }

       function createAliyahRow(type, orderManager) {
       const row = document.createElement('div');
       row.className = 'aliyah-row';

       const label = document.createElement('label');
       label.textContent = `${type}:`;
       row.appendChild(label);

       // משיג את רשימת המתפללים המסודרת ומסנן לפי סוג העלייה
       const list = orderManager.getOrderedMitpallelimList()
           .filter(m => orderManager.isEligibleForAliya(m, type));

       const select = document.createElement('select');
       select.innerHTML = `
           <option value="">בחר עולה</option>
           ${list.map(m => `<option value="${m.name}">${m.name}</option>`).join('')}
       `;
       row.appendChild(select);

       const submitBtn = document.createElement('button');
       submitBtn.textContent = 'שלח עלייה';
       submitBtn.className = 'submit-btn';
       submitBtn.onclick = (event) => {
           const selectedName = select.value;
           if (selectedName) {
               orderManager.recordAliya(selectedName);
               submitAliyaToForm(dateInput.value, currentParasha, type, selectedName, event.target);
           }
       };
       row.appendChild(submitBtn);

       return row;
   }
       function addCustomAliyah(orderManager) {
           const container = document.getElementById('aliyotInputs');
           const row = createAliyahRow('', orderManager);
           row.querySelector('label').textContent = 'עלייה מותאמת:';
           container.appendChild(row);
       }

       async function refreshCongregantsList() {
     const list = document.getElementById('congregantsList');
     list.innerHTML = '<div class="loading">טוען רשימת מתפללים...</div>';

     try {
         // טעינת רשימת המתפללים
         const mitpallelim = await orderManager.loadMitpallelim();
         list.innerHTML = '';

         mitpallelim.forEach(congregant => {
             const card = document.createElement('div');
             card.className = 'congregant-card';
             card.innerHTML = `
                 <div class="congregant-info">
                     <div class="congregant-name">${congregant.name}</div>
                     <div class="congregant-type">${congregant.type}</div>
                 </div>
             `;
             list.appendChild(card);
         });
     } catch (error) {
         console.error('שגיאה בטעינת רשימת מתפללים:', error);
         list.innerHTML = '<div class="error">שגיאה בטעינת הרשימה</div>';
     }
 }
 function createAliyahAssignmentRow(type, assignedPerson, orderManager) {
     const row = document.createElement('div');
     row.className = 'aliyah-row';
 
     // תווית סוג העלייה
     const label = document.createElement('label');
     label.textContent = `${type}:`;
     row.appendChild(label);
 
     // תצוגת המתפלל המשובץ
     const assigneeDisplay = document.createElement('div');
     assigneeDisplay.className = 'assignee-display';
     assigneeDisplay.textContent = assignedPerson ? assignedPerson.name : 'לא נמצא מתפלל מתאים';
     row.appendChild(assigneeDisplay);
 
     // מכיל את כל הכפתורים
     const buttonsContainer = document.createElement('div');
     buttonsContainer.className = 'buttons-container';
 
     // כפתור שיבוץ
     const assignButton = document.createElement('button');
     assignButton.textContent = 'שבץ';
     assignButton.className = 'btn btn-primary';
     assignButton.onclick = async () => {
         if (assignedPerson) {
             try {
                 await orderManager.assignAliyah(assignedPerson.name, type);
                 await submitAliyaToForm(dateInput.value, currentParasha, type, assignedPerson.name, assignButton);
                 
                 // נעילת השורה
                 row.classList.add('locked');
                 buttonsContainer.querySelectorAll('button, select').forEach(el => {
                     if (el !== absentButton && el !== freeChoiceSelect) {
                         el.disabled = true;
                     }
                 });
                 
             } catch (error) {
                 console.error('שגיאה בשיבוץ:', error);
                 alert('שגיאה בשיבוץ העלייה');
             }
         }
     };
     buttonsContainer.appendChild(assignButton);
 
     // כפתור נעדר
     const absentButton = document.createElement('button');
     absentButton.textContent = 'נעדר';
     absentButton.className = 'btn btn-danger';
     absentButton.onclick = async () => {
         if (assignedPerson) {
             try {
                 await orderManager.handleAbsence(assignedPerson.name);
                 
                 // קבלת המתפלל הבא בתור
                 const nextPerson = orderManager.getNextEligibleForAliya(type);
                 if (nextPerson) {
                     assignedPerson = nextPerson.congregant;
                     assigneeDisplay.textContent = nextPerson.congregant.name;
                 }
                 
                 // שחרור נעילת השורה אם הייתה נעולה
                 row.classList.remove('locked');
                 buttonsContainer.querySelectorAll('button, select').forEach(el => {
                     el.disabled = false;
                 });
                 
             } catch (error) {
                 console.error('שגיאה בטיפול בהיעדרות:', error);
                 alert('שגיאה בטיפול בהיעדרות');
             }
         }
     };
     buttonsContainer.appendChild(absentButton);
 
     // תפריט בחירה חופשית
     const freeChoiceSelect = document.createElement('select');
     freeChoiceSelect.className = 'congregant-select';
     freeChoiceSelect.innerHTML = '<option value="">בחירה חופשית</option>';
 
     // מילוי אפשרויות הבחירה
     orderManager.mitpallelimList
         .filter(m => orderManager.isEligibleForAliya(m, type))
         .forEach(m => {
             const option = document.createElement('option');
             option.value = m.name;
             option.textContent = m.name;
             freeChoiceSelect.appendChild(option);
         });
 
     freeChoiceSelect.onchange = async (event) => {
         const selectedName = event.target.value;
         if (selectedName && assignedPerson) {
             try {
                 await orderManager.handleFreeChoice(assignedPerson.name, selectedName, type);
                 await submitAliyaToForm(dateInput.value, currentParasha, type, selectedName, freeChoiceSelect);
                 
                 assigneeDisplay.textContent = selectedName;
                 
                 // נעילת השורה
                 row.classList.add('locked');
                 buttonsContainer.querySelectorAll('button, select').forEach(el => {
                     if (el !== absentButton) {
                         el.disabled = true;
                     }
                 });
                 
             } catch (error) {
                 console.error('שגיאה בבחירה חופשית:', error);
                 alert('שגיאה בבחירה חופשית');
             }
         }
     };
     buttonsContainer.appendChild(freeChoiceSelect);
 
     row.appendChild(buttonsContainer);
     return row;
 }
 async function checkAliyot() {
   try {
       console.log('מתחיל בדיקת עליות');
       if (!orderManager) {
           orderManager = new AliyotOrderManager();
       }
       
       const initSuccess = await orderManager.initialize();
       if (!initSuccess) {
           console.error('אתחול נכשל');
           return;
       }

       dateInput = document.getElementById('dateInput');
       if (!dateInput.value) {
           console.log('לא נבחר תאריך');
           return;
       }

       const selectedDate = new Date(dateInput.value);
       const hebcalInfo = await getHebcalInfo(dateInput.value);
       const aliyotInfo = determineAliyotCount(hebcalInfo);
       currentParasha = await getParasha(dateInput.value);

       // עדכון טבלת מידע
       const resultBody = document.getElementById('resultBody');
       resultBody.innerHTML = '';
       const row = resultBody.insertRow();
       row.insertCell(0).textContent = selectedDate.toLocaleDateString('he-IL');
       row.insertCell(1).textContent = hebcalInfo ? hebcalInfo.hebrewDate : 'לא זוהה';
       row.insertCell(2).textContent = `יום ${hebrewDays[hebcalInfo.dayOfWeek]}`;
       row.insertCell(3).textContent = currentParasha;
       row.insertCell(4).textContent = aliyotInfo.totalAliyot;
       row.insertCell(5).textContent = aliyotInfo.aliyotTypes.join(', ');
       row.insertCell(6).textContent = aliyotInfo.reason;

       // שיבוץ אוטומטי של כל העליות
       console.log('מתחיל שיבוץ אוטומטי');
       const assignments = await orderManager.autoAssignAliyot(aliyotInfo.aliyotTypes);
       console.log('שיבוץ אוטומטי הושלם:', assignments);

       // עדכון הממשק
       const aliyotInputs = document.getElementById('aliyotInputs');
       aliyotInputs.innerHTML = '';

       // יצירת שורות עבור פעולות בהיכל
       console.log('יוצר שורות לפעולות בהיכל');
       for (const action of TEMPLE_ACTIONS) {
           const assignedPerson = assignments.get(action);
           console.log(`יוצר שורה לפעולה ${action}, משובץ:`, assignedPerson);
           const row = createAliyahAssignmentRow(action, assignedPerson, orderManager);
           aliyotInputs.appendChild(row);
       }

       // יצירת שורות עבור עליות לתורה
       console.log('יוצר שורות לעליות לתורה');
       for (const type of aliyotInfo.aliyotTypes) {
           const assignedPerson = assignments.get(type);
           console.log(`יוצר שורה לעלייה ${type}, משובץ:`, assignedPerson);
           const row = createAliyahAssignmentRow(type, assignedPerson, orderManager);
           aliyotInputs.appendChild(row);
       }

       // הצגת האלמנטים
       document.getElementById('resultTable').style.display = 'table';
       document.getElementById('aliyotContainer').style.display = 'block';
       document.getElementById('selected-date-display').textContent =
           `פרשת ${currentParasha}, ${hebcalInfo ? hebcalInfo.hebrewDate : 'לא זוהה'}`;

       console.log('בדיקת עליות הושלמה בהצלחה');

   } catch (error) {
       console.error('שגיאה בבדיקת עליות:', error);
   }
}

 
       // אתחול
       document.addEventListener('DOMContentLoaded', async () => {
    document.getElementById('dateInput').valueAsDate = new Date();
    orderManager = new AliyotOrderManager();
    await orderManager.initialize();
    await refreshCongregantsList();
});
  </script>
</body>
</html>
